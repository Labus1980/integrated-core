{
  "name": "Jambonz Call Status with CustomerData",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "jb-status",
        "responseMode": "onReceived",
        "options": {}
      },
      "name": "Webhook - Jambonz Status",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "your-webhook-id"
    },
    {
      "parameters": {
        "functionCode": "// Ð˜Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¸ Ð´ÐµÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ User-to-User header\nconst userToUser = $json.user_to_user;\nconst displayFrom = $json.from;\nconst displayTo = $json.to;\nconst callTag = $json.call_id;\n\nlet customerData = {};\n\n// Ð”ÐµÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ User-to-User header ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚\nif (userToUser) {\n  try {\n    // Ð”ÐµÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ base64\n    const decoded = Buffer.from(userToUser, 'base64').toString('utf-8');\n    customerData = JSON.parse(decoded);\n    \n    console.log('âœ… CustomerData decoded successfully:', customerData);\n  } catch (e) {\n    console.error('âŒ Failed to parse User-to-User header:', e.message);\n    \n    // Fallback: Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¸Ð· X-Customer-Data ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ\n    const xCustomerData = $json.sip_headers?.['x-customer-data'];\n    if (xCustomerData) {\n      try {\n        customerData = JSON.parse(xCustomerData);\n        console.log('âœ… CustomerData extracted from X-Customer-Data');\n      } catch (e2) {\n        console.error('âŒ Failed to parse X-Customer-Data:', e2.message);\n      }\n    }\n  }\n}\n\n// Ð¢Ð°ÐºÐ¶Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ display headers ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÐµÑÑ‚ÑŒ\nconst sipHeaders = $json.sip_headers || {};\nconst xDisplayFrom = sipHeaders['x-display-from'];\nconst xDisplayTo = sipHeaders['x-display-to'];\nconst xCallTag = sipHeaders['x-call-tag'];\n\n// ÐžÐ±Ð¾Ð³Ð°Ñ‰ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐ¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸\nreturn {\n  // ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð²Ð¾Ð½ÐºÐ°\n  call_sid: $json.call_sid,\n  call_status: $json.call_status,\n  sip_status: $json.sip_status,\n  sip_reason: $json.sip_reason,\n  direction: $json.direction,\n  \n  // ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÐ¼Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)\n  from: xDisplayFrom || displayFrom || $json.from,\n  to: xDisplayTo || displayTo || $json.to,\n  tag: xCallTag || callTag,\n  \n  // ÐžÑ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ\n  originalFrom: $json.from,\n  originalTo: $json.to,\n  \n  // Customer data (Ð´ÐµÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ)\n  customerData: customerData,\n  \n  // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ\n  trace_id: $json.trace_id,\n  account_sid: $json.account_sid,\n  application_sid: $json.application_sid,\n  call_id: $json.call_id,\n  \n  // Timestamp\n  timestamp: new Date().toISOString(),\n  \n  // ÐœÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸\n  hasCustomerData: Object.keys(customerData).length > 0,\n  hasDisplayHeaders: !!(xDisplayFrom || xDisplayTo)\n};"
      },
      "name": "Parse CustomerData",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasCustomerData }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Has CustomerData?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "// Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÑ€Ð°ÑÐ¸Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Zammad\nconst customerData = $json.customerData || {};\nconst from = $json.from || 'Unknown';\nconst to = $json.to || 'Unknown';\nconst tag = $json.tag || '';\nconst callStatus = $json.call_status || 'unknown';\n\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼\nconst statusMap = {\n  'trying': 'â³ Ð˜Ð½Ð¸Ñ†Ð¸Ð¸Ñ€ÑƒÐµÑ‚ÑÑ',\n  'ringing': 'ðŸ“ž Ð—Ð²Ð¾Ð½Ð¸Ñ‚',\n  'in-progress': 'ðŸ“ž Ð’ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ',\n  'completed': 'âœ… Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½',\n  'failed': 'âŒ ÐÐµ ÑƒÐ´Ð°Ð»ÑÑ',\n  'busy': 'ðŸ”´ Ð—Ð°Ð½ÑÑ‚Ð¾',\n  'no-answer': 'ðŸ“µ ÐÐµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚'\n};\n\nconst statusEmoji = statusMap[callStatus] || `âšª ${callStatus}`;\n\n// Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°Ð¼ÐµÑ‚ÐºÑƒ Ð´Ð»Ñ Zammad\nconst note = `\n${statusEmoji}\n\n**ðŸ“‹ Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð²Ð¾Ð½ÐºÐ°:**\nâ€¢ ÐžÑ‚: ${from}\nâ€¢ ÐšÐ¾Ð¼Ñƒ: ${to}\nâ€¢ Ð¢ÐµÐ³: ${tag || 'Ð½ÐµÑ‚'}\nâ€¢ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: ${callStatus}\n\n**ðŸ‘¤ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ðµ:**\nâ€¢ Ð˜Ð¼Ñ: ${customerData.clientName || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}\nâ€¢ ID: ${customerData.clientId || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}\nâ€¢ Ð¢Ð¸Ð¿ Ð·Ð²Ð¾Ð½ÐºÐ°: ${customerData.callType || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}\nâ€¢ Ð¡ÐµÑÑÐ¸Ñ: ${customerData.sessionId || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°'}\nâ€¢ Ð’Ñ€ÐµÐ¼Ñ: ${customerData.timestamp || $json.timestamp}\n${customerData.userAgent ? 'â€¢ User Agent: ' + customerData.userAgent : ''}\n${customerData.location ? 'â€¢ Ð›Ð¾ÐºÐ°Ñ†Ð¸Ñ: ' + (customerData.location.city || '') + ', ' + (customerData.location.country || '') : ''}\n\n**ðŸ”§ Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:**\nâ€¢ Call SID: ${$json.call_sid}\nâ€¢ Trace ID: ${$json.trace_id || 'N/A'}\nâ€¢ Application: ${$json.application_sid}\nâ€¢ SIP Status: ${$json.sip_status} ${$json.sip_reason || ''}\n`;\n\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ customerData\nconst priority = customerData.customFields?.priority || 'normal';\n\n// Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚ÐµÐ³Ð¸\nconst tags = [\n  'webcall',\n  customerData.callType || 'unknown',\n  tag ? `tag:${tag}` : null,\n  callStatus,\n  customerData.customFields?.department || null\n].filter(Boolean);\n\nreturn {\n  // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ‚Ð¸ÐºÐµÑ‚Ð° Ð² Zammad\n  title: `${statusEmoji} ${from} â†’ ${to}`,\n  customer: {\n    email: customerData.clientId ? `${customerData.clientId}@system.local` : 'unknown@system.local',\n    firstname: customerData.clientName ? customerData.clientName.split(' ')[0] : 'Unknown',\n    lastname: customerData.clientName ? customerData.clientName.split(' ').slice(1).join(' ') : 'Customer'\n  },\n  article: {\n    subject: `Ð—Ð²Ð¾Ð½Ð¾Ðº ${callStatus}: ${from} â†’ ${to}`,\n    body: note,\n    type: 'phone',\n    internal: false,\n    sender: 'Customer'\n  },\n  priority: priority,\n  tags: tags,\n  \n  // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ (ÐµÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ Ð² Zammad)\n  customFields: {\n    call_sid: $json.call_sid,\n    call_tag: tag,\n    customer_id: customerData.clientId,\n    call_type: customerData.callType,\n    session_id: customerData.sessionId\n  },\n  \n  // ÐžÑ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐ¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸\n  rawData: $json\n};"
      },
      "name": "Prepare Zammad Ticket",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "url": "https://zammad.okta-solutions.com/api/v1/tickets",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer YOUR_ZAMMAD_API_TOKEN"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "title",
              "value": "={{ $json.title }}"
            },
            {
              "name": "group",
              "value": "Support"
            },
            {
              "name": "customer",
              "value": "={{ $json.customer.email }}"
            },
            {
              "name": "article",
              "value": "={{ JSON.stringify($json.article) }}"
            },
            {
              "name": "priority",
              "value": "={{ $json.priority }}"
            },
            {
              "name": "tags",
              "value": "={{ $json.tags.join(',') }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Create Zammad Ticket",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "functionCode": "// Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ Ð·Ð²Ð¾Ð½ÐºÐ¾Ð² Ð±ÐµÐ· customerData\nconsole.warn('âš ï¸ Call received without customerData');\nconsole.log('Call details:', {\n  call_sid: $json.call_sid,\n  from: $json.from,\n  to: $json.to,\n  status: $json.call_status\n});\n\n// Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ\nreturn {\n  title: `ðŸ“ž ${$json.from} â†’ ${$json.to}`,\n  note: `Ð—Ð²Ð¾Ð½Ð¾Ðº Ð¾Ñ‚ ${$json.from} Ðº ${$json.to}\\n\\nÐ¡Ñ‚Ð°Ñ‚ÑƒÑ: ${$json.call_status}\\nCall SID: ${$json.call_sid}\\n\\nâš ï¸ CustomerData Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚`,\n  tags: ['webcall', 'no-customer-data', $json.call_status],\n  rawData: $json\n};"
      },
      "name": "Log Without CustomerData",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "mode": "chooseBranch",
        "output": "input1"
      },
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°\nconst items = $input.all();\n\nconsole.log('âœ… Processed calls:', items.length);\nconsole.log('Calls with CustomerData:', items.filter(i => i.json.hasCustomerData).length);\nconsole.log('Calls without CustomerData:', items.filter(i => !i.json.hasCustomerData).length);\n\nreturn items;"
      },
      "name": "Final Statistics",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    }
  ],
  "connections": {
    "Webhook - Jambonz Status": {
      "main": [
        [
          {
            "node": "Parse CustomerData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse CustomerData": {
      "main": [
        [
          {
            "node": "Has CustomerData?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has CustomerData?": {
      "main": [
        [
          {
            "node": "Prepare Zammad Ticket",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Without CustomerData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Zammad Ticket": {
      "main": [
        [
          {
            "node": "Create Zammad Ticket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Zammad Ticket": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Without CustomerData": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Final Statistics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {}
}
